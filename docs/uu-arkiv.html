<!doctype html>
<html lang="no">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>UU-status – endringsarkiv</title>
  <style>
    :root {
      --bg: #0b0f14;
      --card: #11161d;
      --muted: #9fb0c3;
      --text: #e7eef7;
      --accent: #6fb3ff;
      --ok: #28a745;
      --warn: #f0ad4e;
      --bad: #dc3545;
      --border: #1f2a36;
      --focus: #9dd1ff;
      --detail-bg: #0e1420;
      --detail-accent: #2a7de1;
    }
    html, body { background: var(--bg); color: var(--text); font: 14px/1.5 system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial, sans-serif; }
    .wrap { max-width: 1100px; margin: 32px auto; padding: 0 16px; }
    h1 { font-size: 28px; margin: 0 0 8px; }
    .muted { color: var(--muted); }
    a { color: var(--accent); text-decoration: none; }
    a:hover { text-decoration: underline; }

    .cards { background: var(--card); border: 1px solid var(--border); border-radius: 16px; padding: 12px; }
    .toolbar { display: grid; gap: 12px; grid-template-columns: 1fr 160px 160px; align-items: end; margin: 18px 0 14px; }
    .toolbar .field { display: flex; flex-direction: column; gap: 6px; }
    .toolbar input, .toolbar select, .toolbar button {
      background: var(--card); border: 1px solid var(--border); color: var(--text);
      padding: 10px 12px; border-radius: 10px; outline: none;
    }
    .toolbar input:focus, .toolbar select:focus, .toolbar button:focus { box-shadow: 0 0 0 3px var(--focus); }
    .toolbar button { cursor: pointer; }

    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 10px 8px; border-bottom: 1px solid var(--border); vertical-align: top; }
    th { text-align: left; font-weight: 600; white-space: nowrap; }
    tr:hover td { background: rgba(255,255,255,0.02); }

    .pill { display: inline-block; padding: 2px 8px; border-radius: 999px; border: 1px solid var(--border); }
    .pill.ok { color: var(--ok); border-color: rgba(40,167,69,.3); }
    .pill.warn { color: var(--warn); border-color: rgba(240,173,78,.3); }
    .pill.bad { color: var(--bad); border-color: rgba(220,53,69,.3); }

    details summary { cursor: pointer; }
    .footer { display:flex; justify-content: space-between; align-items:center; margin-top: 10px; color: var(--muted); font-size: 12px; gap: 12px; flex-wrap: wrap; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>UU-status – endringsarkiv</h1>
    <div class="muted">Viser differanser som er oppdaget i nattlig sammenligning mot forrige snapshot.</div>
    <p><a href="./uu-status.html">← Til oversikten</a></p>

    <div class="toolbar" role="region" aria-label="Filtre for endringsarkiv">
      <div class="field">
        <label for="q">Søk (domene/URL)</label>
        <input id="q" type="search" placeholder="Filtrer på domene eller URL…" autocomplete="off" />
      </div>
      <div class="field">
        <label for="onlyAdded">Filtrer</label>
        <select id="filterMode">
          <option value="">Alle endringer</option>
          <option value="added">Kun nye brudd</option>
          <option value="removed">Kun fjernede brudd</option>
        </select>
      </div>
      <div class="field">
        <label for="dateFrom">Fra dato (UTC)</label>
        <input id="dateFrom" type="date" />
      </div>
    </div>

    <div class="cards" role="region" aria-label="Endringslogg">
      <table id="tbl">
        <thead>
          <tr>
            <th>Dato/tid</th>
            <th>Domene</th>
            <th>URL</th>
            <th>+ / −</th>
            <th>Detaljer</th>
          </tr>
        </thead>
        <tbody id="tbody">
          <tr><td colspan="5" class="muted">Laster endringer…</td></tr>
        </tbody>
      </table>
      <div class="footer">
        <div id="count" class="muted"></div>
        <div class="muted">Kilde: <code>docs/data/uustatus/logs/changes.jsonl</code></div>
      </div>
    </div>
  </div>

  <script type="module">
    const LOG_URL = "./data/uustatus/logs/changes.jsonl";

    function escapeHTML(s) {
      return String(s)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    async function fetchJSONL(url) {
      const res = await fetch(url, { cache: "no-store" });
      if (!res.ok) throw new Error("Kunne ikke hente changes.jsonl");
      const text = await res.text();
      return text
        .split("\n")
        .map(l => l.trim())
        .filter(Boolean)
        .map(l => JSON.parse(l));
    }

    function passesFilters(row, state) {
      const q = state.q;
      const hit = !q || (row.domain?.toLowerCase().includes(q) || row.url?.toLowerCase().includes(q));
      if (!hit) return false;

      if (state.mode === "added" && !(row.added && row.added.length > 0)) return false;
      if (state.mode === "removed" && !(row.removed && row.removed.length > 0)) return false;

      if (state.from) {
        const ts = new Date(row.ts);
        if (isNaN(ts)) return false;
        if (ts < state.from) return false;
      }
      return true;
    }

    function render(rows) {
      const tbody = document.getElementById("tbody");
      const count = document.getElementById("count");
      tbody.innerHTML = "";

      if (!rows.length) {
        const tr = document.createElement("tr");
        const td = document.createElement("td");
        td.colSpan = 5;
        td.className = "muted";
        td.textContent = "Ingen endringer på valgt filter.";
        tr.appendChild(td);
        tbody.appendChild(tr);
        count.textContent = "";
        return;
      }

      for (const r of rows) {
        const plus = (r.added?.length || 0);
        const minus = (r.removed?.length || 0);
        const tr = document.createElement("tr");

        const tdTs = document.createElement("td");
        tdTs.textContent = new Date(r.ts).toLocaleString("no-NO");
        tr.appendChild(tdTs);

        const tdDom = document.createElement("td");
        tdDom.textContent = r.domain || "";
        tr.appendChild(tdDom);

        const tdUrl = document.createElement("td");
        const a = document.createElement("a");
        a.href = r.url; a.target = "_blank"; a.rel = "noopener";
        a.textContent = r.url;
        tdUrl.appendChild(a);
        tr.appendChild(tdUrl);

        const tdDiff = document.createElement("td");
        tdDiff.textContent = `+${plus} / −${minus}`;
        tr.appendChild(tdDiff);

        const tdDet = document.createElement("td");
        const det = document.createElement("details");
        const sum = document.createElement("summary");
        sum.textContent = "Vis";
        det.appendChild(sum);

        const secAdded = document.createElement("div");
        secAdded.innerHTML = "<strong>Nye:</strong>" + (plus ? `<ul>${r.added.map(x=>`<li>${escapeHTML(x)}</li>`).join("")}</ul>` : " <span class='muted'>Ingen</span>");
        det.appendChild(secAdded);

        const secRemoved = document.createElement("div");
        secRemoved.innerHTML = "<strong>Fjernet:</strong>" + (minus ? `<ul>${r.removed.map(x=>`<li>${escapeHTML(x)}</li>`).join("")}</ul>` : " <span class='muted'>Ingen</span>");
        det.appendChild(secRemoved);

        if (r.changed) {
          const pre = document.createElement("pre");
          pre.textContent = JSON.stringify(r.changed, null, 2);
          const hdr = document.createElement("div");
          hdr.innerHTML = "<strong>Andre endringer:</strong>";
          det.appendChild(hdr);
          det.appendChild(pre);
        }

        const snapLink = document.createElement("div");
        const yyyyMmDd = (r.ts || "").slice(0,10);
        snapLink.style.marginTop = ".5rem";
        snapLink.innerHTML = `<a href="./data/uustatus/snapshots/${yyyyMmDd}.json" target="_blank" rel="noopener">Snapshot ${yyyyMmDd}</a>`;
        det.appendChild(snapLink);

        tdDet.appendChild(det);
        tr.appendChild(tdDet);

        tbody.appendChild(tr);
      }

      count.textContent = `${rows.length} endringer`;
    }

    (async function init(){
      const q = document.getElementById("q");
      const mode = document.getElementById("filterMode");
      const dateFrom = document.getElementById("dateFrom");

      let all = [];
      let state = { q: "", mode: "", from: null };

      try {
        all = await fetchJSONL(LOG_URL);
      } catch (e) {
        const tbody = document.getElementById("tbody");
        tbody.innerHTML = `<tr><td colspan="5" class="muted">Feil ved lasting: ${e.message}</td></tr>`;
        return;
      }

      function apply(){
        const rows = all
          .filter(r => passesFilters(r, state))
          .sort((a,b) => new Date(b.ts) - new Date(a.ts));
        render(rows);
      }

      q.addEventListener("input", () => {
        state.q = q.value.trim().toLowerCase();
        apply();
      });
      mode.addEventListener("change", () => {
        state.mode = mode.value;
        apply();
      });
      dateFrom.addEventListener("change", () => {
        state.from = dateFrom.value ? new Date(dateFrom.value + "T00:00:00Z") : null;
        apply();
      });

      apply();
    })();
  </script>
</body>
</html>
