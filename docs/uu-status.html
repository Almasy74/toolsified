<!doctype html>
<html lang="no">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>UU-status</title>
  <style>
    :root {
      --bg: #0b0f14;
      --card: #11161d;
      --muted: #9fb0c3;
      --text: #e7eef7;
      --accent: #6fb3ff;
      --ok: #28a745;
      --warn: #f0ad4e;
      --bad: #dc3545;
      --border: #1f2a36;
      --focus: #9dd1ff;
    }
    html, body { background: var(--bg); color: var(--text); font: 14px/1.5 system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial, sans-serif; }
    .wrap { max-width: 1100px; margin: 32px auto; padding: 0 16px; }
    h1 { font-size: 28px; margin: 0 0 8px; }
    .muted { color: var(--muted); }
    .toolbar {
      display: grid; gap: 12px; grid-template-columns: 1fr 160px 160px 220px 160px; align-items: end; margin: 18px 0 14px;
    }
    .toolbar .field { display: flex; flex-direction: column; gap: 6px; }
    .toolbar input, .toolbar select, .toolbar button {
      background: var(--card); border: 1px solid var(--border); color: var(--text);
      padding: 10px 12px; border-radius: 10px; outline: none;
    }
    .toolbar input:focus, .toolbar select:focus, .toolbar button:focus { box-shadow: 0 0 0 3px var(--focus); }
    .toolbar button { cursor: pointer; }
    .cards { background: var(--card); border: 1px solid var(--border); border-radius: 16px; padding: 12px; }
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 10px 8px; border-bottom: 1px solid var(--border); vertical-align: top; }
    th { text-align: left; font-weight: 600; user-select: none; white-space: nowrap; }
    th.sortable { cursor: pointer; }
    th.sortable .arrow { opacity: .5; margin-left: 6px; font-size: 11px; }
    tr:hover td { background: rgba(255,255,255,0.02); }
    a { color: var(--accent); text-decoration: none; }
    a:hover { text-decoration: underline; }
    .pill { display: inline-block; padding: 2px 8px; border-radius: 999px; border: 1px solid var(--border); }
    .pill.ok { color: var(--ok); border-color: rgba(40,167,69,.3); }
    .pill.warn { color: var(--warn); border-color: rgba(240,173,78,.3); }
    .pill.bad { color: var(--bad); border-color: rgba(220,53,69,.3); }
    .btn-link { background: none; border: 1px solid var(--border); color: var(--text); padding: 6px 10px; border-radius: 10px; cursor: pointer; }
    .footer { display:flex; justify-content: space-between; align-items:center; margin-top: 10px; color: var(--muted); font-size: 12px; gap: 12px; flex-wrap: wrap; }
    .hidden { display: none !important; }
    .kpis { display:flex; gap:10px; align-items:center; flex-wrap: wrap; }
    @media (max-width: 1100px) {
      .toolbar { grid-template-columns: 1fr 1fr; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>UU-status</h1>
    <div class="muted">Samlet oversikt over tilgjengelighetserklæringer (hentes fra uustatus.no). Oppdateres automatisk via GitHub Actions.</div>

    <div class="toolbar" role="region" aria-label="Filtre og søk">
      <div class="field">
        <label for="search">Søk (navn/URL)</label>
        <input id="search" type="search" placeholder="Søk..." autocomplete="off" />
      </div>
      <div class="field">
        <label for="violFilter">Filtrer: brudd</label>
        <select id="violFilter">
          <option value="">Alle</option>
          <option value="0">0 brudd</option>
          <option value="1-5">1–5 brudd</option>
          <option value="6-10">6–10 brudd</option>
          <option value="11+">11+ brudd</option>
        </select>
      </div>
      <div class="field">
        <label for="updateFilter">Oppdatert siden</label>
        <select id="updateFilter">
          <option value="">Når som helst</option>
          <option value="30">Siste 30 dager</option>
          <option value="90">Siste 90 dager</option>
          <option value="365">Siste 12 mnd</option>
        </select>
      </div>
      <div class="field">
        <label for="wcagFilter">Filter: WCAG-krav</label>
        <select id="wcagFilter">
          <option value="">Alle</option>
        </select>
      </div>
      <div class="field">
        <label>&nbsp;</label>
        <button id="downloadBtn" type="button" title="Last ned CSV">Last ned CSV</button>
      </div>
    </div>

    <div class="cards" role="region" aria-label="Tabell med resultater">
      <table id="tbl">
        <thead>
          <tr>
            <th class="sortable" data-key="Navn">Navn <span class="arrow">↕</span></th>
            <th>URL</th>
            <th class="sortable" data-key="Brudd">Brudd</th>
            <th class="sortable" data-key="KravTotalt">Krav</th>
            <th class="sortable" data-key="SistOppdatert">Sist oppdatert</th>
            <th class="sortable" data-key="Opprettet">Opprettet</th>
            <th>Status</th>
            <th>Detaljer</th>
          </tr>
        </thead>
        <tbody id="tbody">
          <tr><td colspan="8" class="muted">Laster data…</td></tr>
        </tbody>
      </table>
      <div class="footer">
        <div id="summary" class="muted"></div>
        <div id="asof" class="muted"></div>
      </div>
    </div>
  </div>

  <script>
    // Filer publisert av workflowen
    const CSV_URL = 'uu-status.csv';                 // ligger i docs/
    const DETAILS_URL = 'uu-status-details.json';    // ligger i docs/

    // Enkel CSV-parser for semikolon
    function parseCSV(text, delimiter=';') {
      const lines = text.trim().split(/\r?\n/);
      const headers = lines[0].split(delimiter).map(h => h.trim());
      const rows = lines.slice(1).map(line => {
        const cols = line.split(delimiter).map(c => c.trim());
        const obj = {};
        headers.forEach((h, i) => obj[h] = cols[i] ?? '');
        return obj;
      });
      return { headers, rows };
    }

    function fmtDate(iso) {
      if (!iso) return '';
      try {
        const d = new Date(iso + 'T12:00:00Z'); // unngå tz-variasjoner
        return d.toLocaleDateString('no-NO', { year: 'numeric', month: 'short', day: '2-digit' });
      } catch { return iso; }
    }

    function pillClass(brudd) {
      const n = Number(brudd || 0);
      if (isNaN(n)) return 'pill';
      if (n === 0) return 'pill ok';
      if (n <= 5) return 'pill warn';
      return 'pill bad';
    }

    function daysSince(iso) {
      if (!iso) return Infinity;
      const then = new Date(iso + 'T00:00:00Z').getTime();
      const now = Date.now();
      return Math.floor((now - then) / (1000 * 60 * 60 * 24));
    }

    function aggregateByCode(detailsArr) {
      const map = new Map();
      for (const d of detailsArr) {
        const uniq = new Set(d.codes || []);
        for (const c of uniq) map.set(c, (map.get(c) || 0) + 1);
      }
      return Array.from(map.entries()).sort((a,b) => b[1]-a[1]);
    }

    function matchesFilters(row, q, violFilter, updateFilter, wcagCode, detByUrl) {
      const hay = (row.Navn + ' ' + row.Url).toLowerCase();
      if (q && !hay.includes(q)) return false;

      const n = Number(row.Brudd || 0);
      if (violFilter === '0' && n !== 0) return false;
      if (violFilter === '1-5' && !(n >= 1 && n <= 5)) return false;
      if (violFilter === '6-10' && !(n >= 6 && n <= 10)) return false;
      if (violFilter === '11+' && !(n >= 11)) return false;

      if (updateFilter) {
        const days = daysSince(row.SistOppdatert);
        if (!(days <= Number(updateFilter))) return false;
      }

      if (wcagCode) {
        const d = detByUrl.get(row.Url);
        const codes = (d && d.codes) || [];
        if (!codes.includes(wcagCode)) return false;
      }
      return true;
    }

    function sortRows(rows, key, asc) {
      const numKeys = new Set(['Brudd','KravTotalt']);
      const dateKeys = new Set(['SistOppdatert','Opprettet']);
      const dir = asc ? 1 : -1;
      return rows.slice().sort((a, b) => {
        let va = a[key] || '', vb = b[key] || '';
        if (numKeys.has(key)) {
          va = Number(va || 0); vb = Number(vb || 0);
          return (va - vb) * dir;
        }
        if (dateKeys.has(key)) {
          if (!va && !vb) return 0;
          if (!va) return 1;
          if (!vb) return -1;
          return (new Date(va) - new Date(vb)) * dir;
        }
        return String(va).localeCompare(String(vb), 'no', { sensitivity:'base' }) * dir;
      });
    }

    (async function init() {
      const tbody = document.getElementById('tbody');
      const search = document.getElementById('search');
      const violFilter = document.getElementById('violFilter');
      const updateFilter = document.getElementById('updateFilter');
      const wcagFilter = document.getElementById('wcagFilter');
      const downloadBtn = document.getElementById('downloadBtn');
      const summary = document.getElementById('summary');
      const asof = document.getElementById('asof');
      const ths = Array.from(document.querySelectorAll('th.sortable'));

      let data = [];
      let view = [];
      let sortKey = 'Navn';
      let sortAsc = true;

      try {
        const [csvRes, detRes] = await Promise.all([
          fetch(CSV_URL, { cache: 'no-store' }),
          fetch(DETAILS_URL, { cache: 'no-store' })
        ]);
        if (!csvRes.ok) throw new Error('Kunne ikke hente CSV');
        if (!detRes.ok) throw new Error('Kunne ikke hente detaljer');

        const txt = await csvRes.text();
        const details = await detRes.json(); // [{url, name, codes[], last_checked}]
        const detByUrl = new Map(details.map(d => [d.url, d]));
        const parsed = parseCSV(txt, ';');
        data = parsed.rows;

        // WCAG-agg + fyll drop-down
        const wcagAgg = aggregateByCode(details);
        for (const [code, count] of wcagAgg) {
          const opt = document.createElement('option');
          opt.value = code;
          opt.textContent = `${code} (${count})`;
          wcagFilter.appendChild(opt);
        }

        // Oppsummering
        const count = data.length;
        const totalBrudd = data.reduce((s, r) => s + (Number(r.Brudd || 0) || 0), 0);
        const zeroCount = data.filter(r => Number(r.Brudd||0) === 0).length;

        // "As of" fra SistSjekket (nyeste)
        const asOfIso = data.map(r => r.SistSjekket).filter(Boolean).sort().slice(-1)[0];
        if (asOfIso) {
          const d = new Date(asOfIso);
          asof.textContent = `Sist sjekket: ${d.toLocaleString('no-NO')}`;
        }

        // Toppbrudd (topp 10)
        const top = wcagAgg.slice(0, 10).map(([code, count]) => `${code} (${count})`).join(' • ');
        summary.textContent = `${count} erklæringer • ${totalBrudd} brudd totalt • ${zeroCount} med 0 brudd${top ? ' • Topp brudd: ' + top : ''}`;

        const apply = () => {
          const q = search.value.trim().toLowerCase();
          const vf = violFilter.value;
          const uf = updateFilter.value;
          const wc = wcagFilter.value;
          view = data.filter(r => matchesFilters(r, q, vf, uf, wc, detByUrl));
          view = sortRows(view, sortKey, sortAsc);
          render();
        };

        const render = () => {
          tbody.innerHTML = '';
          if (view.length === 0) {
            const tr = document.createElement('tr');
            const td = document.createElement('td');
            td.colSpan = 8;
            td.className = 'muted';
            td.textContent = 'Ingen treff på valgt filter.';
            tr.appendChild(td);
            tbody.appendChild(tr);
            return;
          }
          for (const r of view) {
            const tr = document.createElement('tr');

            const tdName = document.createElement('td');
            tdName.textContent = r.Navn || '';
            tr.appendChild(tdName);

            const tdUrl = document.createElement('td');
            const a = document.createElement('a');
            a.href = r.Url; a.target = '_blank'; a.rel = 'noopener';
            a.textContent = r.Url;
            tdUrl.appendChild(a);
            tr.appendChild(tdUrl);

            const tdBrudd = document.createElement('td');
            const pill = document.createElement('span');
            pill.className = pillClass(r.Brudd);
            pill.textContent = r.Brudd === '' ? '—' : r.Brudd;
            tdBrudd.appendChild(pill);
            tr.appendChild(tdBrudd);

            const tdKrav = document.createElement('td');
            tdKrav.textContent = r.KravTotalt || '';
            tr.appendChild(tdKrav);

            const tdUpd = document.createElement('td');
            tdUpd.textContent = fmtDate(r.SistOppdatert);
            tr.appendChild(tdUpd);

            const tdCreate = document.createElement('td');
            tdCreate.textContent = fmtDate(r.Opprettet);
            tr.appendChild(tdCreate);

            const tdStatus = document.createElement('td');
            const sc = Number(r.Statuskode||0);
            tdStatus.textContent = sc ? sc : '';
            tr.appendChild(tdStatus);

            const tdDet = document.createElement('td');
            const btn = document.createElement('button');
            btn.textContent = 'Vis detaljer';
            btn.type = 'button';
            btn.className = 'btn-link';
            tdDet.appendChild(btn);
            tr.appendChild(tdDet);

            // detaljerad (skjult)
            const trDet = document.createElement('tr');
            const tdDetAll = document.createElement('td');
            tdDetAll.colSpan = 8;
            tdDetAll.className = 'muted';
            tdDetAll.style.display = 'none';

            const d = detByUrl.get(r.Url);
            const codes = (d && d.codes && d.codes.length) ? d.codes : [];
            if (codes.length) {
              const wrap = document.createElement('div');
              wrap.style.display = 'flex';
              wrap.style.flexWrap = 'wrap';
              wrap.style.gap = '8px';
              wrap.style.padding = '6px 2px';

              const label = document.createElement('strong');
              label.textContent = 'WCAG-brudd funnet: ';
              tdDetAll.appendChild(label);

              for (const c of codes) {
                const badge = document.createElement('span');
                badge.className = 'pill bad';
                badge.style.cursor = 'pointer';
                badge.textContent = c;
                badge.title = 'Klikk for å filtrere på ' + c;
                badge.addEventListener('click', () => {
                  wcagFilter.value = c;
                  apply();
                  tdDetAll.style.display = ''; // behold åpnet
                  btn.textContent = 'Skjul detaljer';
                });
                wrap.appendChild(badge);
              }
              tdDetAll.appendChild(wrap);
            } else {
              tdDetAll.textContent = 'Ingen detaljer funnet for denne erklæringen.';
            }

            trDet.appendChild(tdDetAll);

            btn.addEventListener('click', () => {
              const show = tdDetAll.style.display === 'none';
              tdDetAll.style.display = show ? '' : 'none';
              btn.textContent = show ? 'Skjul detaljer' : 'Vis detaljer';
            });

            tbody.appendChild(tr);
            tbody.appendChild(trDet);
          }
        };

        // Interaksjoner
        search.addEventListener('input', apply);
        violFilter.addEventListener('change', apply);
        updateFilter.addEventListener('change', apply);
        wcagFilter.addEventListener('change', apply);
        ths.forEach(th => {
          th.addEventListener('click', () => {
            const key = th.dataset.key;
            if (sortKey === key) sortAsc = !sortAsc; else { sortKey = key; sortAsc = true; }
            apply();
          });
        });

        downloadBtn.addEventListener('click', () => {
          const link = document.createElement('a');
          link.href = CSV_URL;
          link.download = 'uu-status.csv';
          document.body.appendChild(link);
          link.click();
          link.remove();
        });

        apply(); // første render
      } catch (e) {
        tbody.innerHTML = `<tr><td colspan="8" class="muted">Feil ved lasting: ${e.message}</td></tr>`;
      }
    })();
  </script>
</body>
</html>
