<!doctype html>
<html lang="no">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>UU-status</title>
  <style>
    :root {
      --bg: #0b0f14;
      --card: #11161d;
      --muted: #9fb0c3;
      --text: #e7eef7;
      --accent: #6fb3ff;
      --ok: #28a745;
      --warn: #f0ad4e;
      --bad: #dc3545;
      --border: #1f2a36;
      --focus: #9dd1ff;
      --detail-bg: #0e1420;
      --detail-accent: #2a7de1;
    }
    html, body { background: var(--bg); color: var(--text); font: 14px/1.5 system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial, sans-serif; }
    .wrap { max-width: 1100px; margin: 32px auto; padding: 0 16px; }
    h1 { font-size: 28px; margin: 0 0 8px; }
    .muted { color: var(--muted); }
    .toolbar {
      display: grid; gap: 12px; grid-template-columns: 1fr 160px 160px 220px 160px; align-items: end; margin: 18px 0 14px;
    }
    .toolbar .field { display: flex; flex-direction: column; gap: 6px; }
    .toolbar input, .toolbar select, .toolbar button {
      background: var(--card); border: 1px solid var(--border); color: var(--text);
      padding: 10px 12px; border-radius: 10px; outline: none;
    }
    .toolbar input:focus, .toolbar select:focus, .toolbar button:focus { box-shadow: 0 0 0 3px var(--focus); }
    .toolbar button { cursor: pointer; }
    .cards { background: var(--card); border: 1px solid var(--border); border-radius: 16px; padding: 12px; }
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 10px 8px; border-bottom: 1px solid var(--border); vertical-align: top; }
    th { text-align: left; font-weight: 600; user-select: none; white-space: nowrap; }
    th.sortable { cursor: pointer; }
    th.sortable .arrow { opacity: .5; margin-left: 6px; font-size: 11px; }
    tr:hover td { background: rgba(255,255,255,0.02); }
    a { color: var(--accent); text-decoration: none; }
    a:hover { text-decoration: underline; }
    .pill { display: inline-block; padding: 2px 8px; border-radius: 999px; border: 1px solid var(--border); }
    .pill.ok { color: var(--ok); border-color: rgba(40,167,69,.3); }
    .pill.warn { color: var(--warn); border-color: rgba(240,173,78,.3); }
    .pill.bad { color: var(--bad); border-color: rgba(220,53,69,.3); }
    .btn-link { background: none; border: 1px solid var(--border); color: var(--text); padding: 6px 10px; border-radius: 10px; cursor: pointer; }
    .footer { display:flex; justify-content: space-between; align-items:center; margin-top: 10px; color: var(--muted); font-size: 12px; gap: 12px; flex-wrap: wrap; }
    .hidden { display: none !important; }

    /* Detaljseksjon styling for tydelig grouping */
    .detail-row td {
      padding: 0; border: none;
    }
    .detail-box {
      margin: 0 0 10px 0;
      background: var(--detail-bg);
      border: 1px solid var(--border);
      border-left: 4px solid var(--detail-accent);
      border-radius: 12px;
      padding: 10px 12px;
    }
    .detail-title {
      font-weight: 600;
      margin-bottom: 8px;
    }
    .detail-tags {
      display: flex; flex-wrap: wrap; gap: 8px;
    }

    /* Agg-tabell for topp brudd */
    .agg { margin-top: 14px; }
    .agg h2 { font-size: 16px; margin: 0 0 8px; }
    .agg table { width: auto; min-width: 280px; border-collapse: collapse; }
    .agg th, .agg td { padding: 6px 10px; border: 1px solid var(--border); }
    .agg th { background: rgba(255,255,255,0.03); }
    .agg a { cursor: pointer; }
    @media (max-width: 1100px) {
      .toolbar { grid-template-columns: 1fr 1fr; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>UU-status</h1>
    <div class="muted">Samlet oversikt over tilgjengelighetserklæringer (hentes fra uustatus.no). Oppdateres automatisk via GitHub Actions.</div>

    <div class="toolbar" role="region" aria-label="Filtre og søk">
      <div class="field">
        <label for="search">Søk (navn)</label>
        <input id="search" type="search" placeholder="Søk..." autocomplete="off" />
      </div>
      <div class="field">
        <label for="violFilter">Filtrer: brudd</label>
        <select id="violFilter">
          <option value="">Alle</option>
          <option value="0">0 brudd</option>
          <option value="1-5">1–5 brudd</option>
          <option value="6-10">6–10 brudd</option>
          <option value="11+">11+ brudd</option>
        </select>
      </div>
      <div class="field">
        <label for="updateFilter">Oppdatert siden</label>
        <select id="updateFilter">
          <option value="">Når som helst</option>
          <option value="30">Siste 30 dager</option>
          <option value="90">Siste 90 dager</option>
          <option value="365">Siste 12 mnd</option>
        </select>
      </div>
      <div class="field">
        <label for="wcagFilter">Filter: WCAG-krav</label>
        <select id="wcagFilter">
          <option value="">Alle</option>
        </select>
      </div>
      <div class="field">
        <label>&nbsp;</label>
        <button id="downloadBtn" type="button" title="Last ned CSV">Last ned CSV</button>
      </div>
    </div>

    <div class="cards" role="region" aria-label="Tabell med resultater">
      <table id="tbl">
        <thead>
          <tr>
            <th class="sortable" data-key="Navn">Navn <span class="arrow">↕</span></th>
            <th class="sortable" data-key="Brudd">Brudd (av X)</th>
            <th class="sortable" data-key="SistOppdatert">Sist oppdatert</th>
            <th class="sortable" data-key="Opprettet">Opprettet</th>
            <th>Detaljer</th>
          </tr>
        </thead>
        <tbody id="tbody">
          <tr><td colspan="5" class="muted">Laster data…</td></tr>
        </tbody>
      </table>

      <div class="footer">
        <div id="summary" class="muted"></div>
        <div id="asof" class="muted"></div>
      </div>

      <!-- Agg-seksjon for “Topp brudd” som liten tabell -->
      <div class="agg" id="agg"></div>
    </div>
  </div>

  <script>
    const CSV_URL = 'uu-status.csv';
    const DETAILS_URL = 'uu-status-details.json';

    function parseCSV(text, delimiter=';') {
      const lines = text.trim().split(/\r?\n/);
      const headers = lines[0].split(delimiter).map(h => h.trim());
      const rows = lines.slice(1).map(line => {
        const cols = line.split(delimiter).map(c => c.trim());
        const obj = {};
        headers.forEach((h, i) => obj[h] = cols[i] ?? '');
        return obj;
      });
      return { headers, rows };
    }

    function fmtDate(iso) {
      if (!iso) return '';
      try {
        const d = new Date(iso + 'T12:00:00Z');
        return d.toLocaleDateString('no-NO', { year: 'numeric', month: 'short', day: '2-digit' });
      } catch { return iso; }
    }

    function pillClass(brudd) {
      const n = Number(brudd || 0);
      if (isNaN(n)) return 'pill';
      if (n === 0) return 'pill ok';
      if (n <= 5) return 'pill warn';
      return 'pill bad';
    }

    function daysSince(iso) {
      if (!iso) return Infinity;
      const then = new Date(iso + 'T00:00:00Z').getTime();
      const now = Date.now();
      return Math.floor((now - then) / (1000 * 60 * 60 * 24));
    }

    function aggregateByCode(detailsArr) {
      const map = new Map();
      for (const d of detailsArr) {
        const uniq = new Set(d.codes || []);
        for (const c of uniq) map.set(c, (map.get(c) || 0) + 1);
      }
      return Array.from(map.entries()).sort((a,b) => b[1]-a[1]);
    }

    function matchesFilters(row, q, violFilter, updateFilter, wcagCode, detByUrl) {
      const hay = (row.Navn).toLowerCase();
      if (q && !hay.includes(q)) return false;

      const n = Number(row.Brudd || 0);
      if (violFilter === '0' && n !== 0) return false;
      if (violFilter === '1-5' && !(n >= 1 && n <= 5)) return false;
      if (violFilter === '6-10' && !(n >= 6 && n <= 10)) return false;
      if (violFilter === '11+' && !(n >= 11)) return false;

      if (updateFilter) {
        const days = daysSince(row.SistOppdatert);
        if (!(days <= Number(updateFilter))) return false;
      }

      if (wcagCode) {
        const d = detByUrl.get(row.Url);
        const codes = (d && d.codes) || [];
        if (!codes.includes(wcagCode)) return false;
      }
      return true;
    }

    function sortRows(rows, key, asc) {
      const numKeys = new Set(['Brudd']);
      const dateKeys = new Set(['SistOppdatert','Opprettet']);
      const dir = asc ? 1 : -1;
      return rows.slice().sort((a, b) => {
        let va = a[key] || '', vb = b[key] || '';
        if (numKeys.has(key)) {
          va = Number(va || 0); vb = Number(vb || 0);
          return (va - vb) * dir;
        }
        if (dateKeys.has(key)) {
          if (!va && !vb) return 0;
          if (!va) return 1;
          if (!vb) return -1;
          return (new Date(va) - new Date(vb)) * dir;
        }
        return String(va).localeCompare(String(vb), 'no', { sensitivity:'base' }) * dir;
      });
    }

    (async function init() {
      const tbody = document.getElementById('tbody');
      const search = document.getElementById('search');
      const violFilter = document.getElementById('violFilter');
      const updateFilter = document.getElementById('updateFilter');
      const wcagFilter = document.getElementById('wcagFilter');
      const downloadBtn = document.getElementById('downloadBtn');
      const summary = document.getElementById('summary');
      const asof = document.getElementById('asof');
      const agg = document.getElementById('agg');
      const ths = Array.from(document.querySelectorAll('th.sortable'));

      let data = [];
      let view = [];
      let sortKey = 'Navn';
      let sortAsc = true;

      try {
        const [csvRes, detRes] = await Promise.all([
          fetch(CSV_URL, { cache: 'no-store' }),
          fetch(DETAILS_URL, { cache: 'no-store' })
        ]);
        if (!csvRes.ok) throw new Error('Kunne ikke hente CSV');
        if (!detRes.ok) throw new Error('Kunne ikke hente detaljer');

        const txt = await csvRes.text();
        const details = await detRes.json();
        const detByUrl = new Map(details.map(d => [d.url, d]));
        const parsed = parseCSV(txt, ';');
        data = parsed.rows;

        // WCAG-agg + fyll drop-down
        const wcagAgg = aggregateByCode(details);
        for (const [code, count] of wcagAgg) {
          const opt = document.createElement('option');
          opt.value = code;
          opt.textContent = `${code} (${count})`;
          wcagFilter.appendChild(opt);
        }

        // Oppsummerings-KPIer
        const count = data.length;
        const totalBrudd = data.reduce((s, r) => s + (Number(r.Brudd || 0) || 0), 0);
        const zeroCount = data.filter(r => Number(r.Brudd||0) === 0).length;

        const asOfIso = data.map(r => r.SistSjekket).filter(Boolean).sort().slice(-1)[0];
        if (asOfIso) {
          const d = new Date(asOfIso);
          asof.textContent = `Sist sjekket: ${d.toLocaleString('no-NO')}`;
        }
        summary.textContent = `${count} erklæringer • ${totalBrudd} brudd totalt • ${zeroCount} med 0 brudd`;

        // Agg-tabell i egen seksjon
        if (wcagAgg.length) {
          const top = wcagAgg.slice(0, 15); // topp 15
          const box = document.createElement('div');
          const h2 = document.createElement('h2');
          h2.textContent = 'Topp brudd (WCAG-krav)';
          box.appendChild(h2);

          const tbl = document.createElement('table');
          const thead = document.createElement('thead');
          const hr = document.createElement('tr');
          const h1 = document.createElement('th'); h1.textContent = 'Krav';
          const h2c = document.createElement('th'); h2c.textContent = 'Antall løsninger';
          hr.appendChild(h1); hr.appendChild(h2c); thead.appendChild(hr);
          tbl.appendChild(thead);

          const tb = document.createElement('tbody');
          for (const [code, count] of top) {
            const tr = document.createElement('tr');
            const td1 = document.createElement('td');
            const link = document.createElement('a');
            link.textContent = code;
            link.title = 'Klikk for å filtrere på ' + code;
            link.addEventListener('click', () => {
              wcagFilter.value = code;
              apply();
              window.scrollTo({ top: 0, behavior: 'smooth' });
            });
            td1.appendChild(link);
            const td2 = document.createElement('td');
            td2.textContent = count;
            tr.appendChild(td1); tr.appendChild(td2);
            tb.appendChild(tr);
          }
          tbl.appendChild(tb);
          box.className = 'agg';
          box.appendChild(tbl);
          agg.innerHTML = '';
          agg.appendChild(box);
        }

        const apply = () => {
          const q = search.value.trim().toLowerCase();
          const vf = violFilter.value;
          const uf = updateFilter.value;
          const wc = wcagFilter.value;
          view = data.filter(r => matchesFilters(r, q, vf, uf, wc, detByUrl));
          view = sortRows(view, sortKey, sortAsc);
          render();
        };

        const render = () => {
          tbody.innerHTML = '';
          if (view.length === 0) {
            const tr = document.createElement('tr');
            const td = document.createElement('td');
            td.colSpan = 5;
            td.className = 'muted';
            td.textContent = 'Ingen treff på valgt filter.';
            tr.appendChild(td);
            tbody.appendChild(tr);
            return;
          }
          for (const r of view) {
            const tr = document.createElement('tr');

            // Navn som klikkbar lenke (erstatter URL-kolonnen)
            const tdName = document.createElement('td');
            const a = document.createElement('a');
            a.href = r.Url; a.target = '_blank'; a.rel = 'noopener';
            a.textContent = r.Navn || r.Url;
            tdName.appendChild(a);
            tr.appendChild(tdName);

            // Brudd (av X)
            const tdBrudd = document.createElement('td');
            const n = Number(r.Brudd || 0);
            const total = r.KravTotalt || '48';
            const pill = document.createElement('span');
            pill.className = pillClass(n);
            pill.textContent = isNaN(n) ? '—' : `${n} / ${total}`;
            tdBrudd.appendChild(pill);
            tr.appendChild(tdBrudd);

            const tdUpd = document.createElement('td');
            tdUpd.textContent = fmtDate(r.SistOppdatert);
            tr.appendChild(tdUpd);

            const tdCreate = document.createElement('td');
            tdCreate.textContent = fmtDate(r.Opprettet);
            tr.appendChild(tdCreate);

            const tdDet = document.createElement('td');
            const btn = document.createElement('button');
            btn.textContent = 'Vis detaljer';
            btn.type = 'button';
            btn.className = 'btn-link';
            tdDet.appendChild(btn);
            tr.appendChild(tdDet);

            // Detaljerad med tydelig visuelt skille
            const trDet = document.createElement('tr');
            trDet.className = 'detail-row';
            const tdDetAll = document.createElement('td');
            tdDetAll.colSpan = 5;
            tdDetAll.style.display = 'none';

            const box = document.createElement('div');
            box.className = 'detail-box';

            const title = document.createElement('div');
            title.className = 'detail-title';
            title.textContent = 'WCAG-brudd funnet:';
            box.appendChild(title);

            const d = detByUrl.get(r.Url);
            const codes = (d && d.codes && d.codes.length) ? d.codes : [];
            const tags = document.createElement('div');
            tags.className = 'detail-tags';

            if (codes.length) {
              for (const c of codes) {
                const badge = document.createElement('span');
                badge.className = 'pill bad';
                badge.style.cursor = 'pointer';
                badge.textContent = c;
                badge.title = 'Klikk for å filtrere på ' + c;
                badge.addEventListener('click', () => {
                  wcagFilter.value = c;
                  apply();
                  tdDetAll.style.display = ''; // behold åpen
                  btn.textContent = 'Skjul detaljer';
                });
                tags.appendChild(badge);
              }
            } else {
              const none = document.createElement('span');
              none.className = 'muted';
              none.textContent = 'Ingen detaljer funnet for denne erklæringen.';
              tags.appendChild(none);
            }

            box.appendChild(tags);
            tdDetAll.appendChild(box);
            trDet.appendChild(tdDetAll);

            btn.addEventListener('click', () => {
              const show = tdDetAll.style.display === 'none';
              tdDetAll.style.display = show ? '' : 'none';
              btn.textContent = show ? 'Skjul detaljer' : 'Vis detaljer';
            });

            tbody.appendChild(tr);
            tbody.appendChild(trDet);
          }
        };

        // Interaksjoner
        search.addEventListener('input', apply);
        violFilter.addEventListener('change', apply);
        updateFilter.addEventListener('change', apply);
        wcagFilter.addEventListener('change', apply);
        ths.forEach(th => {
          th.addEventListener('click', () => {
            const key = th.dataset.key;
            if (sortKey === key) sortAsc = !sortAsc; else { sortKey = key; sortAsc = true; }
            apply();
          });
        });

        downloadBtn.addEventListener('click', () => {
          const link = document.createElement('a');
          link.href = CSV_URL;
          link.download = 'uu-status.csv';
          document.body.appendChild(link);
          link.click();
          link.remove();
        });

        apply();
      } catch (e) {
        tbody.innerHTML = `<tr><td colspan="5" class="muted">Feil ved lasting: ${e.message}</td></tr>`;
      }
    })();
  </script>
</body>
</html>
