<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Smart Crypto Converter</title>
  <link rel="stylesheet" href="/style.css" />
  <style>
    main.container {
      max-width: 100%;
      padding: 1rem;
    }
    .table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1rem;
      table-layout: auto;
    }
    .table th, .table td {
      border: 1px solid #ddd;
      padding: 0.5rem;
      text-align: center;
      white-space: nowrap;
    }
    .row-controls {
      margin-top: 1rem;
      display: flex;
      gap: 1rem;
    }
    .input-group {
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
    }
  </style>
</head>
<body>
  <main class="container">
    <h1>Smart Crypto Converter</h1>
    <div style="overflow-x: auto">
      <table class="table" id="cryptoTable">
        <thead>
          <tr>
            <th>Beløp</th>
            <th>Krypto</th>
            <th>Fiat</th>
            <th>Kjøpsdato</th>
            <th>Salgsdato</th>
            <th>Kjøpskurs</th>
            <th>Salgskurs</th>
            <th>Gevinst/tap</th>
            <th></th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
    <div class="row-controls">
      <button onclick="addRow()">Legg til rad</button>
    </div>
  </main>

  <script>
    const supportedCryptos = ['BTC', 'ETH', 'SOL'];
    const supportedFiats = ['NOK', 'USD', 'EUR'];
    const apiKey = '61afd9bedcb6a6417369f2bb518b7352f01bb62d0051d9a4803b8aa83acf4227';

    function addRow() {
      const tbody = document.querySelector("#cryptoTable tbody");
      const row = document.createElement("tr");

      row.innerHTML = `
        <td><input type="number" step="any" class="amount" /></td>
        <td>
          <select class="crypto">
            ${supportedCryptos.map(c => `<option>${c}</option>`).join('')}
          </select>
        </td>
        <td>
          <select class="fiat">
            ${supportedFiats.map(f => `<option>${f}</option>`).join('')}
          </select>
        </td>
        <td><input type="date" class="buy-date" /></td>
        <td><input type="date" class="sell-date" /></td>
        <td class="buy-rate">-</td>
        <td class="sell-rate">-</td>
        <td class="diff">-</td>
        <td><button onclick="removeRow(this)">X</button></td>
      `;

      tbody.appendChild(row);

      row.querySelectorAll("input, select").forEach(el => {
        el.addEventListener("change", () => updateRow(row));
      });
    }

    function removeRow(btn) {
      btn.closest("tr").remove();
    }

    async function getRate(crypto, fiat, date) {
      if (!date) return null;
      const selectedDate = new Date(date);
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      selectedDate.setHours(0, 0, 0, 0);
      if (selectedDate > today) return null;

      const timestamp = Math.floor(selectedDate.getTime() / 1000);
      let targetFiat = fiat;
      let conversionRate = 1;

      try {
        // Bruk dagens kurs hvis datoen er i dag
        const isToday = selectedDate.getTime() === today.getTime();
        let usdRate;

        if (isToday) {
          // Bruk dagens kurs API
          const todayUrl = `https://min-api.cryptocompare.com/data/price?fsym=${crypto}&tsyms=USD`;
          console.log("Henter dagens kryptokurs fra:", todayUrl);
          const todayRes = await fetch(todayUrl);
          if (!todayRes.ok) {
            console.error("Feil ved henting av dagens kryptokurs:", await todayRes.text());
            return null;
          }
          const todayData = await todayRes.json();
          console.log("Dagens kryptokurs data:", todayData);
          usdRate = todayData['USD'];
        } else {
          // Bruk historisk kurs API
          const cryptoUrl = `https://min-api.cryptocompare.com/data/pricehistorical?fsym=${crypto}&tsyms=USD&ts=${timestamp}`;
          console.log("Henter historisk kryptokurs fra:", cryptoUrl);
          const cryptoRes = await fetch(cryptoUrl);
          if (!cryptoRes.ok) {
            console.error("Feil ved henting av historisk kryptokurs:", await cryptoRes.text());
            return null;
          }
          const cryptoData = await cryptoRes.json();
          console.log("Historisk kryptokurs data:", cryptoData);
          usdRate = cryptoData[crypto]?.['USD'];
        }

        if (!usdRate) {
          console.error("Ingen USD kurs funnet for", crypto, "på dato", date);
          return null;
        }

        // Hvis vi trenger NOK eller EUR, konverter fra USD
        if (fiat === 'NOK' || fiat === 'EUR') {
          let fxRate;
          if (isToday) {
            // Bruk dagens valutakurs
            const todayFxUrl = `https://min-api.cryptocompare.com/data/price?fsym=USD&tsyms=${fiat}`;
            console.log("Henter dagens valutakurs fra:", todayFxUrl);
            const todayFxRes = await fetch(todayFxUrl);
            if (!todayFxRes.ok) {
              console.error("Feil ved henting av dagens valutakurs:", await todayFxRes.text());
              return null;
            }
            const todayFxData = await todayFxRes.json();
            console.log("Dagens valutakurs data:", todayFxData);
            fxRate = todayFxData[fiat];
          } else {
            // Bruk historisk valutakurs
            const fxUrl = `https://min-api.cryptocompare.com/data/pricehistorical?fsym=USD&tsyms=${fiat}&ts=${timestamp}`;
            console.log("Henter historisk valutakurs fra:", fxUrl);
            const fxRes = await fetch(fxUrl);
            if (!fxRes.ok) {
              console.error("Feil ved henting av historisk valutakurs:", await fxRes.text());
              return null;
            }
            const fxData = await fxRes.json();
            console.log("Historisk valutakurs data:", fxData);
            fxRate = fxData['USD']?.[fiat];
          }

          if (!fxRate) {
            console.error("Ingen valutakurs funnet for USD til", fiat, "på dato", date);
            return null;
          }
          conversionRate = fxRate;
        }

        const finalRate = usdRate * conversionRate;
        console.log("Final rate:", finalRate, "USD:", usdRate, "Conversion:", conversionRate);
        return finalRate;
      } catch (err) {
        console.error("Feil ved henting av kurs:", err);
        return null;
      }
    }

    async function updateRow(row) {
      const amount = parseFloat(row.querySelector(".amount").value);
      const crypto = row.querySelector(".crypto").value;
      const fiat = row.querySelector(".fiat").value.toUpperCase();
      const buyDate = row.querySelector(".buy-date").value;
      const sellDate = row.querySelector(".sell-date").value;

      const buyRateCell = row.querySelector(".buy-rate");
      const sellRateCell = row.querySelector(".sell-rate");
      const diffCell = row.querySelector(".diff");

      if (!crypto || !fiat || !amount) return;

      const buyRate = await getRate(crypto, fiat, buyDate);
      const sellRate = await getRate(crypto, fiat, sellDate);

      buyRateCell.textContent = buyRate === 'VALUTAFEIL' ? 'Valutakurs mangler' : (buyRate ? buyRate.toFixed(2) : (buyDate ? 'Feil' : '-'));
      sellRateCell.textContent = sellRate === 'VALUTAFEIL' ? 'Valutakurs mangler' : (sellRate ? sellRate.toFixed(2) : (sellDate ? 'Feil' : '-'));

      if (typeof buyRate === 'number' && typeof sellRate === 'number') {
        const diff = (sellRate - buyRate) * amount;
        diffCell.textContent = diff.toFixed(2);
        diffCell.style.color = diff >= 0 ? 'green' : 'red';
      } else {
        diffCell.textContent = '-';
        diffCell.style.color = 'inherit';
      }
    }

    addRow();
  </script>
</body>
</html>
